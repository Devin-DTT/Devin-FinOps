<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard FinOps - Análisis de Consumo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Dashboard FinOps</h1>
                    <p class="text-gray-600">Métricas Cognition</p>
                </div>
                <div class="flex gap-3 items-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/2/22/Cognition_AI.png" alt="Cognition Logo" class="rounded" style="height: 40px;">
                    <img src="https://www.e-spincorp.com/wp-content/uploads/2018/07/logo-deloitte-espincorp.png" alt="Deloitte Logo" class="rounded" style="height: 40px;">
                </div>
            </div>
        </div>

        <!-- Sección de Métricas Ejecutivas -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Métricas Ejecutivas - Comparativa Mensual</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- ACUs (Consumo) -->
                <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                    <div id="acus-title" class="text-sm font-semibold text-gray-600 mb-2">Consumo de ACUs Mes</div>
                    <div id="acus-mes" class="text-4xl font-bold text-gray-800 mb-3">-</div>
                    <div class="border-t border-gray-200 pt-3">
                        <div id="acus-subtitle" class="text-xs font-semibold text-gray-500 mb-2">vs. Mes Anterior</div>
                        <div id="acus-variacion" class="text-lg font-semibold text-gray-700 mb-1">-</div>
                        <div id="acus-porcentaje" class="text-sm text-gray-600">-</div>
                    </div>
                </div>

                <!-- Coste Total (€) -->
                <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                    <div id="coste-title" class="text-sm font-semibold text-gray-600 mb-2">Coste Total Mes</div>
                    <div id="coste-mes" class="text-4xl font-bold text-gray-800 mb-3">-</div>
                    <div class="border-t border-gray-200 pt-3">
                        <div id="coste-subtitle" class="text-xs font-semibold text-gray-500 mb-2">vs. Mes Anterior</div>
                        <div id="coste-variacion" class="text-lg font-semibold text-gray-700 mb-1">-</div>
                        <div id="coste-porcentaje" class="text-sm text-gray-600">-</div>
                    </div>
                </div>

                <!-- Variación Absoluta de Coste (€) -->
                <div id="diferencia-card" class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                    <div class="text-sm font-semibold text-gray-600 mb-2">Variación Absoluta de Coste (€)</div>
                    <div id="diferencia-coste" class="text-4xl font-bold text-gray-800 mb-3">-</div>
                    <div class="border-t border-gray-200 pt-3">
                        <div id="diferencia-indicator" class="text-lg font-semibold">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Gráfico de Consumo -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Consumo de ACUs</h2>
                <div class="flex gap-2">
                    <button id="btn-view-daily" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">
                        Diario
                    </button>
                    <button id="btn-view-weekly" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold">
                        Semanal
                    </button>
                </div>
            </div>
            
            <!-- Filtros de Período -->
            <div class="mb-6 flex flex-wrap gap-4 items-center">
                <div class="flex items-center gap-2">
                    <label for="month-filter" class="text-sm font-semibold text-gray-700">Filtro por Mes:</label>
                    <select id="month-filter" class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos los meses</option>
                    </select>
                </div>
                
                <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-gray-700">Filtro por Días:</span>
                    <button id="btn-60-days" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                        Últimos 60 días
                    </button>
                    <button id="btn-90-days" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        Últimos 90 días
                    </button>
                </div>

                <div class="flex items-center gap-2">
                    <label for="user-filter" class="text-sm font-semibold text-gray-700">Filtro por Usuario:</label>
                    <select id="user-filter" class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos los usuarios</option>
                    </select>
                </div>

                <div class="flex items-center gap-2">
                    <label for="org-filter" class="text-sm font-semibold text-gray-700">Filtro por Organización:</label>
                    <select id="org-filter" class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas las organizaciones</option>
                    </select>
                </div>
            </div>

            <!-- Chart Container -->
            <div class="relative" style="height: 400px;">
                <canvas id="consumption-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // MOCK DATA GENERATION
        // ==========================================
        
        // Define users and organizations for simulation
        const users = ['user-a', 'user-b', 'user-c', 'user-d', 'user-e'];
        const organizations = ['org-alpha', 'org-beta', 'org-gamma'];

        // Generate Mock Daily Data (90+ days spanning September, October, November 2025)
        const dailyConsumptionData = [];
        const startDate = new Date('2025-09-01');
        const endDate = new Date('2025-11-30');
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            // Generate realistic ACU consumption (30-80 ACUs per day with some variation)
            const baseACUs = 50;
            const variation = Math.random() * 30 - 15; // -15 to +15
            const acus = Math.max(30, baseACUs + variation);
            const cost = acus * 0.05; // €0.05 per ACU
            
            // Randomly assign user and organization
            const userId = users[Math.floor(Math.random() * users.length)];
            const organizationId = organizations[Math.floor(Math.random() * organizations.length)];
            
            dailyConsumptionData.push({
                date: dateStr,
                acus: parseFloat(acus.toFixed(2)),
                cost: parseFloat(cost.toFixed(2)),
                userId: userId,
                organizationId: organizationId
            });
        }

        // ==========================================
        // GLOBAL STATE
        // ==========================================
        
        // Current filters state
        const currentFilters = {
            days: null,
            month: null,
            user: null,
            organization: null,
            viewType: 'daily' // 'daily' or 'weekly'
        };

        // ==========================================
        // CORE FUNCTIONS
        // ==========================================

        // Format currency in EUR
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR'
            }).format(value);
        }

        // Format number with thousand separators
        function formatNumber(value) {
            return new Intl.NumberFormat('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Calculate metrics dynamically from daily data
        function calculateMetricsFromData() {
            const today = new Date();
            const currentMonth = today.getMonth(); // 0-11
            const currentYear = today.getFullYear();
            
            // Calculate current month metrics
            const currentMonthData = dailyConsumptionData.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
            });
            
            const acusMes = currentMonthData.reduce((sum, item) => sum + item.acus, 0);
            const costeMes = currentMonthData.reduce((sum, item) => sum + item.cost, 0);
            
            // Calculate previous month metrics
            const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            
            const prevMonthData = dailyConsumptionData.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate.getMonth() === prevMonth && itemDate.getFullYear() === prevYear;
            });
            
            const acusMesAnterior = prevMonthData.reduce((sum, item) => sum + item.acus, 0);
            const costeMesAnterior = prevMonthData.reduce((sum, item) => sum + item.cost, 0);
            
            // Calculate differences
            const diferenciaACUs = acusMes - acusMesAnterior;
            const diferenciaCost = costeMes - costeMesAnterior;
            const porcentajeACUs = acusMesAnterior !== 0 ? ((diferenciaACUs / acusMesAnterior) * 100) : 0;
            const porcentajeCost = costeMesAnterior !== 0 ? ((diferenciaCost / costeMesAnterior) * 100) : 0;
            
            return {
                acusMes,
                acusMesAnterior,
                costeMes,
                costeMesAnterior,
                diferenciaACUs,
                diferenciaCost,
                porcentajeACUs,
                porcentajeCost
            };
        }

        // Get Spanish month name
        function getSpanishMonthName(monthIndex) {
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            return monthNames[monthIndex];
        }

        // Render Executive Metrics Cards
        function renderMetrics() {
            const metrics = calculateMetricsFromData();
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            
            const currentMonthName = getSpanishMonthName(currentMonth);
            const prevMonthName = getSpanishMonthName(prevMonth);
            
            // Update ACUs card titles
            document.getElementById('acus-title').textContent = 
                `Consumo de ACUs Mes (${currentMonthName} ${currentYear})`;
            document.getElementById('acus-subtitle').textContent = 
                `vs. Mes Anterior (${prevMonthName} ${prevYear})`;
            
            // Update Coste card titles
            document.getElementById('coste-title').textContent = 
                `Coste Total Mes (${currentMonthName} ${currentYear})`;
            document.getElementById('coste-subtitle').textContent = 
                `vs. Mes Anterior (${prevMonthName} ${prevYear})`;
            
            // ACUs Mes
            document.getElementById('acus-mes').textContent = formatNumber(metrics.acusMes);
            document.getElementById('acus-variacion').textContent = 
                (metrics.diferenciaACUs >= 0 ? '+' : '') + formatNumber(metrics.diferenciaACUs) + ' ACUs';
            document.getElementById('acus-porcentaje').textContent = 
                (metrics.porcentajeACUs >= 0 ? '+' : '') + metrics.porcentajeACUs.toFixed(2) + '%';
            
            // Coste Mes
            document.getElementById('coste-mes').textContent = formatCurrency(metrics.costeMes);
            document.getElementById('coste-variacion').textContent = 
                (metrics.diferenciaCost >= 0 ? '+' : '') + formatCurrency(metrics.diferenciaCost);
            document.getElementById('coste-porcentaje').textContent = 
                (metrics.porcentajeCost >= 0 ? '+' : '') + metrics.porcentajeCost.toFixed(2) + '%';
            
            // Diferencia de Coste with executive arrow icons and color coding
            document.getElementById('diferencia-coste').textContent = formatCurrency(metrics.diferenciaCost);
            
            const diferenciaIndicator = document.getElementById('diferencia-indicator');
            
            if (metrics.diferenciaCost < 0) {
                // Negative difference = savings (green arrow)
                diferenciaIndicator.innerHTML = '<span class="text-green-600">↓ Ahorro</span>';
            } else if (metrics.diferenciaCost > 0) {
                // Positive difference = increase (red arrow)
                diferenciaIndicator.innerHTML = '<span class="text-red-600">↑ Incremento</span>';
            } else {
                // No change (gray)
                diferenciaIndicator.innerHTML = '<span class="text-gray-600">= Sin cambio</span>';
            }
        }

        // Filter Data applying all active filters
        function filterData() {
            let filteredData = [...dailyConsumptionData];
            
            // Apply month filter
            if (currentFilters.month) {
                filteredData = filteredData.filter(item => item.date.startsWith(currentFilters.month));
            }
            
            // Apply days filter
            if (currentFilters.days) {
                const today = new Date(dailyConsumptionData[dailyConsumptionData.length - 1].date);
                const cutoffDate = new Date(today);
                cutoffDate.setDate(cutoffDate.getDate() - currentFilters.days);
                
                filteredData = filteredData.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= cutoffDate;
                });
            }
            
            // Apply user filter
            if (currentFilters.user) {
                filteredData = filteredData.filter(item => item.userId === currentFilters.user);
            }
            
            // Apply organization filter
            if (currentFilters.organization) {
                filteredData = filteredData.filter(item => item.organizationId === currentFilters.organization);
            }
            
            return filteredData;
        }

        // Get ISO week number (YYYY-WW format)
        function getISOWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getFullYear()}-${String(weekNo).padStart(2, '0')}`;
        }

        // Aggregate daily data by week
        function aggregateByWeek(dailyData) {
            const weeklyMap = {};
            
            dailyData.forEach(item => {
                const weekKey = getISOWeek(item.date);
                
                if (!weeklyMap[weekKey]) {
                    weeklyMap[weekKey] = {
                        week: weekKey,
                        acus: 0,
                        cost: 0
                    };
                }
                
                weeklyMap[weekKey].acus += item.acus;
                weeklyMap[weekKey].cost += item.cost;
            });
            
            // Convert to array and sort by week
            const weeklyData = Object.values(weeklyMap).sort((a, b) => a.week.localeCompare(b.week));
            
            // Format for chart: use "Semana YYYY-WW" as label
            return weeklyData.map(item => ({
                date: `Semana ${item.week}`,
                acus: parseFloat(item.acus.toFixed(2)),
                cost: parseFloat(item.cost.toFixed(2))
            }));
        }

        // Chart.js instance
        let consumptionChart = null;

        // Update Chart with filtered data (Dual-Axis: ACUs and Cost)
        function updateChart(data) {
            // Apply weekly aggregation if viewType is 'weekly'
            let chartData = data;
            if (currentFilters.viewType === 'weekly') {
                chartData = aggregateByWeek(data);
            }
            
            const labels = chartData.map(item => item.date);
            const acusData = chartData.map(item => item.acus);
            const costData = chartData.map(item => item.cost);
            
            const ctx = document.getElementById('consumption-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (consumptionChart) {
                consumptionChart.destroy();
            }
            
            // Create new dual-axis chart
            consumptionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ACUs Consumidos',
                            data: acusData,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Coste Diario (€)',
                            data: costData,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            yAxisID: 'yCost'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (context.datasetIndex === 0) {
                                            label += context.parsed.y.toFixed(2) + ' ACUs';
                                        } else {
                                            label += context.parsed.y.toFixed(2) + ' €';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Fecha'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 20
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ACUs'
                            },
                            beginAtZero: true
                        },
                        yCost: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Coste (€)'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Populate month filter dropdown
        function populateMonthFilter() {
            const monthSelect = document.getElementById('month-filter');
            const months = new Set();
            
            dailyConsumptionData.forEach(item => {
                const yearMonth = item.date.substring(0, 7); // "2025-09"
                months.add(yearMonth);
            });
            
            // Convert to array and sort
            const sortedMonths = Array.from(months).sort();
            
            // Create month name mapping
            const monthNames = {
                '01': 'Enero', '02': 'Febrero', '03': 'Marzo', '04': 'Abril',
                '05': 'Mayo', '06': 'Junio', '07': 'Julio', '08': 'Agosto',
                '09': 'Septiembre', '10': 'Octubre', '11': 'Noviembre', '12': 'Diciembre'
            };
            
            sortedMonths.forEach(yearMonth => {
                const [year, month] = yearMonth.split('-');
                const monthName = monthNames[month];
                const option = document.createElement('option');
                option.value = yearMonth;
                option.textContent = `${monthName} ${year}`;
                monthSelect.appendChild(option);
            });
        }

        // Populate user filter dropdown
        function populateUserFilter() {
            const userSelect = document.getElementById('user-filter');
            const uniqueUsers = new Set();
            
            dailyConsumptionData.forEach(item => {
                uniqueUsers.add(item.userId);
            });
            
            // Convert to array and sort
            const sortedUsers = Array.from(uniqueUsers).sort();
            
            sortedUsers.forEach(userId => {
                const option = document.createElement('option');
                option.value = userId;
                option.textContent = userId;
                userSelect.appendChild(option);
            });
        }

        // Populate organization filter dropdown
        function populateOrgFilter() {
            const orgSelect = document.getElementById('org-filter');
            const uniqueOrgs = new Set();
            
            dailyConsumptionData.forEach(item => {
                uniqueOrgs.add(item.organizationId);
            });
            
            // Convert to array and sort
            const sortedOrgs = Array.from(uniqueOrgs).sort();
            
            sortedOrgs.forEach(orgId => {
                const option = document.createElement('option');
                option.value = orgId;
                option.textContent = orgId;
                orgSelect.appendChild(option);
            });
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================

        document.getElementById('month-filter').addEventListener('change', function(e) {
            currentFilters.month = e.target.value || null;
            const filteredData = filterData();
            updateChart(filteredData);
        });

        document.getElementById('btn-60-days').addEventListener('click', function() {
            currentFilters.days = 60;
            currentFilters.month = null;
            document.getElementById('month-filter').value = '';
            const filteredData = filterData();
            updateChart(filteredData);
        });

        document.getElementById('btn-90-days').addEventListener('click', function() {
            currentFilters.days = 90;
            currentFilters.month = null;
            document.getElementById('month-filter').value = '';
            const filteredData = filterData();
            updateChart(filteredData);
        });

        document.getElementById('user-filter').addEventListener('change', function(e) {
            currentFilters.user = e.target.value || null;
            const filteredData = filterData();
            updateChart(filteredData);
        });

        document.getElementById('org-filter').addEventListener('change', function(e) {
            currentFilters.organization = e.target.value || null;
            const filteredData = filterData();
            updateChart(filteredData);
        });

        // View toggle buttons
        document.getElementById('btn-view-daily').addEventListener('click', function() {
            currentFilters.viewType = 'daily';
            // Update button styles
            document.getElementById('btn-view-daily').className = 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold';
            document.getElementById('btn-view-weekly').className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold';
            // Update chart
            const filteredData = filterData();
            updateChart(filteredData);
        });

        document.getElementById('btn-view-weekly').addEventListener('click', function() {
            currentFilters.viewType = 'weekly';
            // Update button styles
            document.getElementById('btn-view-daily').className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold';
            document.getElementById('btn-view-weekly').className = 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold';
            // Update chart
            const filteredData = filterData();
            updateChart(filteredData);
        });

        // ==========================================
        // INITIALIZATION
        // ==========================================

        document.addEventListener('DOMContentLoaded', function() {
            // Render metrics cards
            renderMetrics();
            
            // Populate all filter dropdowns
            populateMonthFilter();
            populateUserFilter();
            populateOrgFilter();
            
            // Initialize chart with last 90 days (default view)
            currentFilters.days = 90;
            const defaultData = filterData();
            updateChart(defaultData);
        });
    </script>
</body>
</html>
